<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width">
    <title class="articlesTitleSec">Loading...</title>
    <link rel="stylesheet" href="/stylesheets/github-markdown.css">
    <link rel="stylesheet" href="/stylesheets/bot-frame.css">
    <!-- Math Support -->
    <link rel="stylesheet" href="/stylesheets/katex.min.css">
    <style>
        .headerQuoteSec blockquote {
            padding: 0 0 0 15px;
        }

        .cover-title, .cover-subtitle {
            position: absolute;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .cover-title {
            top: 30%;
        }

        .cover-subtitle {
            top: 60%;
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <header>
            <nav class="navSec"></nav>
            <div class="contactSec"></div>
            <div class="headerTitleSec"></div>
            <div class="headerQuoteSec"></div>
        </header>
        <section class="markdown-body"></section>
        <footer class="footerSec"></footer>
    </div>
    <script src="/javascripts/marked.js"></script>
    <script src="/javascripts/bot-mark.js"></script>
    <script src="/javascripts/bot-frame.js"></script>
    <!-- Math Support -->
    <script src="/javascripts/katex.min.js"></script>
    <script src="/javascripts/auto-render.min.js"></script>
    <script>
        var mdSec = document.getElementsByClassName('markdown-body')[0];

        // Move first element from 'mdSec to 'dstSec if matching 'tagName
        // Return innerHTML of the element
        function MoveFirstElement(dstSec, tagName) {
            var childLen = mdSec.childNodes.length;
            var curElem = 0;

            // Find First Element
            while (curElem < childLen &&
                mdSec.childNodes[curElem].nodeType != 1)
                curElem++;

            if (curElem >= childLen) return null;
            if (tagName && mdSec.childNodes[curElem].tagName.toUpperCase() != tagName.toUpperCase())
                return null;

            var content = mdSec.childNodes[curElem].innerHTML;
            dstSec.innerHTML += '<' + tagName + '>' + content + '</' + tagName + '>';
            mdSec.removeChild(mdSec.childNodes[curElem]);
            return content;
        }

        // Load style from '?style, and add style tag to document
        function LoadStyle() {
            var styles = {};
            var stylesParam = GetSearchParam('style').split('+');
            for (var i = 0; i < stylesParam.length; i++)
                styles[stylesParam[i]] = true;

            var styleElem = document.createElement('style');
            if (styles['cover']) {
                // TODO: slide-cover
                document.getElementsByClassName('headerTitleSec')[0].classList.add('cover-title');
                document.getElementsByClassName('headerQuoteSec')[0].classList.add('cover-subtitle');
                document.getElementsByTagName('header')[0].style.pageBreakAfter = 'always';
            }
            if (styles['word'])
                styleElem.innerHTML += '@page { margin: 25.4mm 31.8mm; }';
            else
                styleElem.innerHTML += '@page { margin: 15mm 15mm; }';
            if (styles['slide'])
                styleElem.innerHTML += '@page { size: 297mm 210mm; }';
            else
                styleElem.innerHTML += '@page { size: 210mm 297mm; }';
            if (styles['toc-page-break'])
                styleElem.innerHTML += '@media print { .markdown-toc { page-break-after: always; } }';
            if (styles['two-column'])
                styleElem.innerHTML += '@media print { .markdown-body { column-count: 2; } }';
            document.head.appendChild(styleElem);
        }

        function GetAbsPath(filename) {
            // Trick: set and then get 'href' to find the absolute path of filename
            // http://stackoverflow.com/questions/2639070/get-the-full-uri-from-the-href-property-of-a-link
            var aElem = document.createElement('A');
            aElem.href = filename;

            // NOT Same Origin File
            if (aElem.href.indexOf(location.origin) == -1)
                return null;

            // Get absPath (including ending '/')
            return aElem.href.substr(0, aElem.href.lastIndexOf('/') + 1);
        }

        function GetRelPath(basePath, destPath) {
            var commonLen = 0;
            for (; commonLen < basePath.length || commonLen < destPath.length; commonLen++)
                if (basePath[commonLen] != destPath[commonLen])
                    break;

            for (; commonLen > 0; commonLen--)
                if (basePath[commonLen - 1] == '/')
                    break;

            // Case: Contains Relationship
            if (commonLen >= basePath.length || commonLen >= destPath.length)
                commonLen = Math.min(basePath.length, destPath.length);

            var parents = basePath.substring(commonLen)
                .replace(/[^\/]*$/, '').replace(/.*?\//g, '../');

            return (parents + destPath.substring(commonLen)) || './';
        }

        function FixRelativePaths(mdAbsPath) {
            // Trick: use reflection 'attrName' to access property
            // http://stackoverflow.com/questions/4244896/dynamically-access-object-property-using-variable
            function fixAll(tagName, attrName) {
                var elems = mdSec.getElementsByTagName(tagName);
                for (var j = 0; j < elems.length; j++) {
                    // Store original literal of attr
                    var rawSrc = elems[j].getAttribute(attrName);
                    var src = elems[j][attrName];

                    if (src.indexOf(location.origin) != -1 &&  // Same Origin
                        rawSrc.indexOf(location.origin) == -1 &&  // Relative Path
                        rawSrc[0] != '/' &&  // NOT Root-Relative Path
                        rawSrc[0] != '#')  // NOT Hash
                    {
                        // Get absPath
                        var aElem = document.createElement('A');
                        aElem.href = mdAbsPath + rawSrc;
                        var absPath = aElem.href;

                        // Get relPath
                        var relPath = GetRelPath(location.origin + location.pathname, absPath);

                        // Set with pattern
                        elems[j][attrName] = absPath;
                    }
                }
            }

            fixAll('A', 'href');
            fixAll('IMG', 'src');
        }

        var post = GetSearchParam('post');
        if (post == '') {
            if (location.hash != null && location.hash.length > 1) {
                // Compatible with legacy hash routing
                location = './?post=' + location.hash.substr(1);
            }
            else {
                LoadLayout('archive.md', function (md, title) {
                    var renderer = new MarkdownRenderer();
                    mdSec.innerHTML = renderer.render(md);

                    var anchors = mdSec.getElementsByTagName('A');
                    for (var j = 0; j < anchors.length; j++) {
                        var raw = anchors[j].getAttribute('href');  // literal
                        anchors[j].href = './?post=' + raw;
                    }
                    title('Articles');
                });
            }
        }
        else {
            // Hide contact section
            var contactSec = document.getElementsByClassName('contactSec')[0];
            contactSec.style.display = 'none';

            LoadLayout(post + '.md', function (md, title) {
                var renderer = new MarkdownRenderer();
                mdSec.innerHTML = renderer.render(md);

                // Fix anchor/img relative paths
                FixRelativePaths(GetAbsPath(post));

                // Detect title and handle contactSec
                var titleStr =
                    MoveFirstElement(document.getElementsByClassName('headerTitleSec')[0], 'h1');
                if (titleStr) {
                    MoveFirstElement(document.getElementsByClassName('headerQuoteSec')[0]);
                    contactSec.parentElement.removeChild(contactSec);
                }
                else {
                    titleStr = post.substr(post.lastIndexOf('/') + 1);  // filename
                    contactSec.style.display = 'block';
                }

                // Style
                LoadStyle();

                // Render math
                renderMathInElement(mdSec, {
                    delimiters: [
                        { left: '$$', right: '$$', display: true },
                        { left: '\\[', right: '\\]', display: true },
                        { left: '$', right: '$', display: false },
                        { left: '\\(', right: '\\)', display: false }
                    ],
                    ignoredTags: [
                        'script', 'noscript', 'style', 'textarea', 'pre', 'code'
                    ]
                });

                title(titleStr);
            });
        }
    </script>
</body>
</html>
