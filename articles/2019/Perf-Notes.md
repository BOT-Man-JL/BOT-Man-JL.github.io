# 性能笔记

> 2019/8/28
> 
> Windows 性能相关笔记

## 指标

- 崩溃率：崩溃机器数/启动机器数，崩溃次数/启动次数
- 假死率：超过 10s 不响应心跳消息（机器数，次数）
- 卡顿率：超过 2s 不响应心跳消息（机器数，次数）
- 白屏：页面区域持续 2s 白屏（机器数，次数）
- 主界面/导航页加载完成时间/CPU 时间（工具：旭日图/XPerf）
- 主界面/导航页首次绘制完成时间：用户感知加载完成时间
- 用户触发启动 到 首次绘制完成时间：用户感知打开总时间

## 维度

- 冷热启动：File I/O 不同于 Disk I/O
- 启动时间：启动量以周为周期变化，节假日启动少
- 启动方式：主动打开，默认打开方式，第三方调起
- 操作系统：版本/32-64位
- 硬件环境：CPU 个数/内存大小/是否 SSD
- 共存环境：安全软件影响
- 网吧环境：网管软件影响
- 网络环境：运营商劫持影响
- 打开 URL：根据 host 聚合

## 工具

- WinDbg：查看崩溃 + 调试
- XPerf：查看细化的 trace（基于 ETW 更底层）
- Visual Studio Diagnostic Tool：粗略分析 CPU/内存（最上层）
- Process Explorer：查看进程关系
- Process Monitor：查看进程活动情况（偏底层）
- RAMMap/VMMap：查看 系统/进程 内存分布

## 策略

- 启动快
  - 核心思想：能去掉就去掉 -> 能优化就优化 -> 都不能再预执行
  - 原生绘制：提升体验/收入（漏斗：提前关闭/流量劫持/加载错误）
  - 延迟加载：优先完成首次绘制，其他功能往后放
  - 代码预取：避免内存映射文件 分散/少量 读取导致频繁 Page Fault（尤其是冷启动工作集从无到有）
  - 指令重排：把启动时需要的 指令/数据 放在一起（例如 Profile Guided Optimization；但可能破坏局部性原则，小工作集导致 Page Fault 抖动）
  - 驱动加速：通过驱动加载资源并锁定在内存中，避免启动时再次加载
  - 智能预判：基于 AI 判断是否需要提前启动、打开网页
  - 宽带提速：优化页面加载/下载体验
- 占用少
  - 进程合并：扩展进程合并
  - 内存清理：空闲时 trim 工作集，回收物理内存
  - 智能休眠：基于 AI 判断是否需要关闭/回收页面内存
- 捞数据
  - 下发云控：针对不同用户下发，修改逻辑开关/收集非敏感数据
  - 收集转储：收集崩溃 Mini/Full Dump 文件
  - 远程调试：用户机器上使用 WinDbg 代理
